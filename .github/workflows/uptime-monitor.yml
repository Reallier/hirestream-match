name: Uptime Monitor (TalentAI)

# æ¯ 5 åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡
on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  HEALTH_CHECK_URL: https://api.talentai.intjsys.com/health
  ADMIN_EMAIL: icey123580@gmail.com
  SERVICE_NAME: TalentAI API

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check service health
        id: health
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$HEALTH_CHECK_URL" || echo "000")
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Health check failed! HTTP Code: $HTTP_CODE"
            echo "status=failed" >> $GITHUB_OUTPUT
          else
            echo "âœ… Health check passed"
            echo "status=ok" >> $GITHUB_OUTPUT
          fi

      - name: Send alert email on failure
        if: steps.health.outputs.status == 'failed'
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          TIMESTAMP=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          
          curl -X POST 'https://api.resend.com/emails' \
            -H "Authorization: Bearer $RESEND_API_KEY" \
            -H 'Content-Type: application/json' \
            -d "{
              \"from\": \"ç®€åºæ™ºèƒ½å‘Šè­¦ <noreply@auth.intjsys.com>\",
              \"to\": \"$ADMIN_EMAIL\",
              \"subject\": \"ğŸš¨ æœåŠ¡å®•æœºå‘Šè­¦: $SERVICE_NAME\",
              \"html\": \"<div style='font-family: sans-serif; padding: 20px;'><h2 style='color: #dc2626;'>âš ï¸ æœåŠ¡å¼‚å¸¸é€šçŸ¥</h2><p><strong>æœåŠ¡åç§°:</strong> $SERVICE_NAME</p><p><strong>æ£€æµ‹æ—¶é—´:</strong> $TIMESTAMP</p><p><strong>HTTP çŠ¶æ€ç :</strong> ${{ steps.health.outputs.http_code }}</p><p><strong>æ£€æµ‹åœ°å€:</strong> $HEALTH_CHECK_URL</p><hr><p style='color: #666; font-size: 12px;'>æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€ï¼Œè¯·å°½å¿«æ£€æŸ¥æœåŠ¡çŠ¶æ€ã€‚</p></div>\"
            }"
          
          echo "ğŸ“§ Alert email sent to $ADMIN_EMAIL"
